import React, { useState, useEffect, useRef, Spinner } from 'react';
import mapboxgl from 'mapbox-gl';
import axios from 'axios';

//const socket = io.connect("http://localhost:8080/");
mapboxgl.accessToken = 'pk.eyJ1IjoiYWJkdWxsYWh0ZWFtaGFpbCIsImEiOiJjbDdvbGtucjEwNm91M3ZueGZwaTEwcDg4In0.Be48QvgVjJ5-MNt3pzEnfw';

const LineTraceMap = ({selectedRider}) => {
  	const mapContainer = useRef();
  	let map;

  	const [mapData, setMapData] = useState({
		type: "FeatureCollection",
		features: [{
				type: "Feature",
				geometry: {
					type: "LineString",
					coordinates: [[67.06514346480135, 24.873956517462556]]
				}
			}]
	});

	const [markerData, setMarkerData] = useState({
		type: 'FeatureCollection',
		features: [
			{
				type: 'Feature',
				geometry: {
					type: 'Point',
					coordinates: [67.06514346480135, 24.873956517462556]
				},
				properties: {
					title: 'Start Location'
				}
			},
			{
				type: 'Feature',
				geometry: {
					type: 'Point',
					coordinates: [67.06514346480135, 24.875956517462556]
				},
				properties: {
					title: 'End Location'
				}
			}
		]
	});

	useEffect(() => {
		map = new mapboxgl.Map({
			container:mapContainer.current,
			style: 'mapbox://styles/mapbox/streets-v11',//'mapbox://styles/mapbox/dark-v10',
			center:[67.06514346480135, 24.873956517462556],
			zoom: 15
		});
		map.on('load', async () => {
            map.resize();
			map.loadImage(
				'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
				(error, image) => {
					if (error) throw error;
					map.addImage('custom-marker', image);
					map.addSource('points', { type: 'geojson', data: markerData });
					map.addLayer({
						'id': 'points',
						'type': 'symbol',
						'source': 'points',
						'layout': {
							'icon-image': 'custom-marker',
							'text-field': ['get', 'title'],
							'text-font': [
								'Open Sans Semibold',
								'Arial Unicode MS Bold'
							],
							'text-offset': [0, 1.25],
							'text-anchor': 'top'
						}
					});
				}
			);

			map.addSource('trace', { type: 'geojson', data: mapData })
			map.addLayer({
				'id': 'trace',
				'type': 'line',
				'source': 'trace',
				'layout': {
					'line-join': 'round',
					'line-cap': 'round'
				},
				'paint': {
					'line-color': '#03AA46',
					'line-width': 4,
					'line-opacity': 0.8
				}
			})
		});

		// setTimeout( function(){
		// 	 axios.get('http://localhost:8080/riders/getRoute',{ headers:{ id:`${selectedRider}` }}).then((x)=>{ getMatch(x.data.result.Item.routes) })
		//   }, 1000)

		const interval = setInterval(() => {
			axios.get('http://localhost:8080/riders/getRoute',{ headers:{ id:`${selectedRider}` }}).then((x)=>{ getMatch([
				[
					67.0653462,
					24.8739224
				],
				[
					67.0653529,
					24.8739209
				],
				[
					67.0653436,
					24.8739218
				],
				[
					67.0653436,
					24.8739218
				],
				[
					67.0653394,
					24.8739247
				],
				[
					67.0653378,
					24.8739253
				],
				[
					67.0653486,
					24.873923
				],
				[
					67.0653486,
					24.873923
				],
				[
					67.0653461,
					24.8739238
				],
				[
					67.0653459,
					24.8739183
				],
				[
					67.0653435,
					24.8739191
				],
				[
					67.0653592,
					24.8739134
				],
				[
					67.0653592,
					24.8739134
				],
				[
					67.0653617,
					24.8739146
				],
				[
					67.0653617,
					24.8739146
				],
				[
					67.0653617,
					24.8739146
				],
				[
					67.0653493,
					24.8739248
				],
				[
					67.0653493,
					24.8739248
				],
				[
					67.0653493,
					24.8739248
				],
				[
					67.0653484,
					24.8739238
				],
				[
					67.0653484,
					24.8739238
				],
				[
					67.0653479,
					24.8739255
				],
				[
					67.0653585,
					24.8739175
				],
				[
					67.0653524,
					24.8739198
				],
				[
					67.0653581,
					24.8739131
				],
				[
					67.0653576,
					24.8739148
				],
				[
					67.0653576,
					24.8739148
				],
				[
					67.0653496,
					24.8739236
				],
				[
					67.0653532,
					24.8739186
				],
				[
					67.0653085,
					24.8739354
				],
				[
					67.065343,
					24.8739195
				],
				[
					67.0653572,
					24.8739168
				],
				[
					67.0653624,
					24.873915
				],
				[
					67.0653473,
					24.8739192
				],
				[
					67.0653604,
					24.873917
				],
				[
					67.0653604,
					24.873917
				],
				[
					67.0653657,
					24.8739162
				],
				[
					67.0653444,
					24.8739207
				],
				[
					67.0653444,
					24.8739207
				],
				[
					67.0653442,
					24.8739156
				],
				[
					67.0653359,
					24.8739101
				],
				[
					67.0653468,
					24.8739112
				],
				[
					67.0653468,
					24.8739112
				],
				[
					67.0653478,
					24.8739112
				],
				[
					67.0653478,
					24.8739112
				],
				[
					67.0653478,
					24.8739112
				],
				[
					67.0653329,
					24.8739132
				],
				[
					67.0653329,
					24.8739132
				],
				[
					67.0653329,
					24.8739132
				],
				[
					67.0653466,
					24.8739109
				],
				[
					67.0653466,
					24.8739109
				],
				[
					67.0653466,
					24.8739109
				],
				[
					67.0653504,
					24.8739128
				],
				[
					67.0653504,
					24.8739128
				],
				[
					67.0653504,
					24.8739128
				],
				[
					67.0652966,
					24.8739322
				],
				[
					67.0652966,
					24.8739322
				],
				[
					67.0652966,
					24.8739322
				],
				[
					67.0653262,
					24.8739234
				],
				[
					67.0653388,
					24.8739197
				],
				[
					67.0653388,
					24.8739197
				],
				[
					67.0653023,
					24.8739405
				],
				[
					67.0653023,
					24.8739405
				],
				[
					67.0653023,
					24.8739405
				],
				[
					67.0653328,
					24.8739211
				],
				[
					67.0653328,
					24.8739211
				],
				[
					67.0653328,
					24.8739211
				],
				[
					67.0653499,
					24.8739195
				],
				[
					67.0653499,
					24.8739195
				],
				[
					67.0653499,
					24.8739195
				],
				[
					67.0653323,
					24.8739259
				],
				[
					67.0653323,
					24.8739259
				],
				[
					67.0652995,
					24.8739392
				],
				[
					67.0653557,
					24.8739146
				],
				[
					67.0653113,
					24.8739387
				],
				[
					67.0653467,
					24.8739203
				],
				[
					67.0653467,
					24.8739203
				],
				[
					67.0653463,
					24.8739121
				],
				[
					67.0653521,
					24.8739153
				],
				[
					67.0653521,
					24.8739153
				],
				[
					67.0653551,
					24.8739128
				],
				[
					67.0653551,
					24.8739128
				],
				[
					67.0653551,
					24.8739128
				],
				[
					67.0653465,
					24.8739195
				],
				[
					67.0653465,
					24.8739195
				],
				[
					67.0653465,
					24.8739195
				],
				[
					67.0653573,
					24.8739135
				],
				[
					67.0653557,
					24.8739103
				],
				[
					67.0653538,
					24.8739142
				],
				[
					67.0653467,
					24.8739209
				],
				[
					67.0653467,
					24.8739209
				],
				[
					67.0653523,
					24.8739143
				],
				[
					67.0653523,
					24.8739143
				],
				[
					67.0653523,
					24.8739143
				],
				[
					67.0653513,
					24.8739095
				],
				[
					67.0653372,
					24.8739223
				],
				[
					67.0653506,
					24.8739129
				],
				[
					67.0653371,
					24.8739164
				],
				[
					67.0653499,
					24.8739136
				],
				[
					67.0653499,
					24.8739136
				],
				[
					67.0653484,
					24.8739145
				],
				[
					67.0653484,
					24.8739145
				],
				[
					67.0653484,
					24.8739145
				],
				[
					67.0653528,
					24.8739144
				],
				[
					67.0653502,
					24.8739221
				],
				[
					67.0653502,
					24.8739221
				],
				[
					67.0653402,
					24.8739235
				],
				[
					67.0653402,
					24.8739235
				],
				[
					67.0653402,
					24.8739235
				],
				[
					67.0653508,
					24.8739154
				],
				[
					67.0653508,
					24.8739154
				],
				[
					67.0653508,
					24.8739154
				],
				[
					67.0653503,
					24.8739141
				],
				[
					67.0653513,
					24.873912
				],
				[
					67.0653513,
					24.873912
				],
				[
					67.0653623,
					24.8739146
				],
				[
					67.0653623,
					24.8739146
				],
				[
					67.0653623,
					24.8739146
				],
				[
					67.0653635,
					24.8739151
				],
				[
					67.065327,
					24.8739284
				],
				[
					67.065327,
					24.8739284
				],
				[
					67.0653037,
					24.8739321
				],
				[
					67.0653481,
					24.8739213
				],
				[
					67.0653481,
					24.8739213
				],
				[
					67.0653481,
					24.8739213
				],
				[
					67.065346,
					24.8739156
				],
				[
					67.0653331,
					24.8739104
				],
				[
					67.0653553,
					24.8739683
				],
				[
					67.0652004,
					24.873803
				],
				[
					67.0652004,
					24.873803
				],
				[
					67.0652294,
					24.8738354
				],
				[
					67.0652294,
					24.8738354
				],
				[
					67.0652294,
					24.8738354
				],
				[
					67.065263,
					24.8738357
				],
				[
					67.065263,
					24.8738357
				],
				[
					67.065263,
					24.8738357
				],
				[
					67.0647174,
					24.8738166
				],
				[
					67.0651853,
					24.8746666
				],
				[
					67.065562,
					24.8748573
				],
				[
					67.0660849,
					24.8756438
				],
				[
					67.0665294,
					24.8763615
				],
				[
					67.0665294,
					24.8763615
				],
				[
					67.0662452,
					24.8766114
				],
				[
					67.0658728,
					24.8768733
				],
				[
					67.0655373,
					24.8769821
				],
				[
					67.0655373,
					24.8769821
				],
				[
					67.0657071,
					24.8769417
				],
				[
					67.0657114,
					24.8768481
				],
				[
					67.0657114,
					24.8768481
				],
				[
					67.0661963,
					24.876625
				],
				[
					67.0661963,
					24.876625
				],
				[
					67.0664184,
					24.8765115
				],
				[
					67.0666701,
					24.8762913
				],
				[
					67.0680589,
					24.8778113
				],
				[
					67.0682108,
					24.8778971
				],
				[
					67.0666917,
					24.8760638
				],
				[
					67.0666506,
					24.8758545
				],
				[
					67.0666506,
					24.8758545
				],
				[
					67.0655754,
					24.8747371
				],
				[
					67.0655754,
					24.8747371
				],
				[
					67.0655754,
					24.8747371
				],
				[
					67.0651931,
					24.8738435
				],
				[
					67.0651931,
					24.8738435
				],
				[
					67.0651931,
					24.8738435
				],
				[
					67.0653222,
					24.8739183
				],
				[
					67.0653222,
					24.8739183
				],
				[
					67.0653222,
					24.8739183
				],
				[
					67.0653439,
					24.8739102
				],
				[
					67.0653439,
					24.8739102
				],
				[
					67.0653043,
					24.8738737
				],
				[
					67.0653081,
					24.8739297
				],
				[
					67.0651088,
					24.8738906
				],
				[
					67.0649251,
					24.8737138
				],
				[
					67.0651884,
					24.8738315
				],
				[
					67.0651884,
					24.8738315
				],
				[
					67.0651477,
					24.8737672
				],
				[
					67.0651477,
					24.8737672
				],
				[
					67.0651477,
					24.8737672
				],
				[
					67.0657517,
					24.875359
				],
				[
					67.0657517,
					24.875359
				],
				[
					67.0657517,
					24.875359
				],
				[
					67.0664173,
					24.8764681
				],
				[
					67.0664173,
					24.8764681
				],
				[
					67.0664173,
					24.8764681
				],
				[
					67.0660836,
					24.8767743
				],
				[
					67.0660836,
					24.8767743
				],
				[
					67.0657243,
					24.8769233
				],
				[
					67.0658845,
					24.8767932
				],
				[
					67.0657783,
					24.8768882
				],
				[
					67.0659707,
					24.8767775
				],
				[
					67.0659707,
					24.8767775
				],
				[
					67.065775,
					24.8769166
				],
				[
					67.065775,
					24.8769166
				],
				[
					67.065775,
					24.8769166
				],
				[
					67.0657106,
					24.8768876
				],
				[
					67.0657106,
					24.8768876
				],
				[
					67.0657106,
					24.8768876
				],
				[
					67.0657255,
					24.8768464
				],
				[
					67.0657255,
					24.8768464
				],
				[
					67.0657146,
					24.8768661
				],
				[
					67.0657146,
					24.8768661
				],
				[
					67.0657146,
					24.8768661
				],
				[
					67.0657802,
					24.8768947
				],
				[
					67.0657802,
					24.8768947
				],
				[
					67.0657228,
					24.8768574
				],
				[
					67.0657174,
					24.8768776
				],
				[
					67.0657142,
					24.8768652
				],
				[
					67.0657142,
					24.8768652
				],
				[
					67.0657164,
					24.8768662
				],
				[
					67.0657164,
					24.8768662
				],
				[
					67.0657164,
					24.8768662
				],
				[
					67.0657164,
					24.8768662
				],
				[
					67.0657092,
					24.8768781
				],
				[
					67.0657092,
					24.8768781
				],
				[
					67.0657092,
					24.8768781
				],
				[
					67.0657071,
					24.8768737
				],
				[
					67.0657071,
					24.8768737
				],
				[
					67.0657185,
					24.8768698
				],
				[
					67.0657185,
					24.8768698
				],
				[
					67.0657339,
					24.8768717
				],
				[
					67.0657339,
					24.8768717
				],
				[
					67.0657339,
					24.8768717
				],
				[
					67.0657266,
					24.8768782
				],
				[
					67.0657266,
					24.8768782
				],
				[
					67.0657266,
					24.8768782
				],
				[
					67.0657047,
					24.8768631
				],
				[
					67.0657047,
					24.8768631
				],
				[
					67.0657047,
					24.8768631
				],
				[
					67.0657089,
					24.8768749
				],
				[
					67.0657089,
					24.8768749
				],
				[
					67.0657143,
					24.8768652
				],
				[
					67.0657066,
					24.8768613
				],
				[
					67.0657242,
					24.876873
				],
				[
					67.0657242,
					24.876873
				],
				[
					67.0657487,
					24.8768695
				],
				[
					67.0657487,
					24.8768695
				],
				[
					67.0657205,
					24.8768755
				],
				[
					67.0657185,
					24.8768743
				],
				[
					67.0657156,
					24.8768778
				],
				[
					67.0657156,
					24.8768778
				],
				[
					67.0656899,
					24.8768625
				],
				[
					67.0656899,
					24.8768625
				],
				[
					67.065811,
					24.8768978
				],
				[
					67.0662661,
					24.8766067
				],
				[
					67.0662661,
					24.8766067
				],
				[
					67.0663776,
					24.8765408
				],
				[
					67.0666365,
					24.8761865
				],
				[
					67.0660755,
					24.8756691
				],
				[
					67.0658977,
					24.8753239
				],
				[
					67.0654092,
					24.8743459
				],
				[
					67.0652462,
					24.8739062
				],
				[
					67.0652122,
					24.8738288
				],
				[
					67.0651615,
					24.8738155
				],
				[
					67.0652055,
					24.8739075
				],
				[
					67.0652055,
					24.8739075
				],
				[
					67.0653232,
					24.8739085
				],
				[
					67.0653232,
					24.8739085
				],
				[
					67.0653232,
					24.8739085
				],
				[
					67.0653472,
					24.8739215
				],
				[
					67.0653472,
					24.8739215
				],
				[
					67.0653472,
					24.8739215
				],
				[
					67.065348,
					24.8739251
				],
				[
					67.065348,
					24.8739251
				],
				[
					67.065348,
					24.8739251
				],
				[
					67.0653476,
					24.8739246
				],
				[
					67.0653597,
					24.8739154
				],
				[
					67.0653434,
					24.8739211
				],
				[
					67.0653481,
					24.873917
				],
				[
					67.0653481,
					24.873917
				],
				[
					67.0653414,
					24.8739189
				],
				[
					67.0653414,
					24.8739189
				],
				[
					67.065326,
					24.8739307
				],
				[
					67.065326,
					24.8739307
				],
				[
					67.065326,
					24.8739307
				],
				[
					67.0653493,
					24.8739281
				],
				[
					67.0653429,
					24.8739228
				],
				[
					67.0653429,
					24.8739228
				],
				[
					67.0653437,
					24.8739206
				],
				[
					67.0653427,
					24.8739184
				],
				[
					67.0652992,
					24.8739353
				],
				[
					67.0652992,
					24.8739353
				],
				[
					67.065337,
					24.8739277
				],
				[
					67.0653562,
					24.873928
				],
				[
					67.0653562,
					24.873928
				],
				[
					67.0653521,
					24.8739273
				],
				[
					67.0653282,
					24.8739318
				],
				[
					67.0653282,
					24.8739318
				],
				[
					67.065343,
					24.8739206
				],
				[
					67.0653499,
					24.8739238
				],
				[
					67.0653499,
					24.8739238
				],
				[
					67.0653516,
					24.8739266
				],
				[
					67.0653545,
					24.873923
				],
				[
					67.0653545,
					24.873923
				],
				[
					67.0653107,
					24.8739366
				],
				[
					67.0653563,
					24.8739171
				],
				[
					67.0653563,
					24.8739171
				],
				[
					67.0653547,
					24.8739203
				],
				[
					67.065359,
					24.8739199
				],
				[
					67.065359,
					24.8739199
				],
				[
					67.0653528,
					24.8739224
				],
				[
					67.0653493,
					24.8739252
				],
				[
					67.0653493,
					24.8739252
				],
				[
					67.065346,
					24.8739246
				],
				[
					67.0652858,
					24.8739439
				],
				[
					67.0652858,
					24.8739439
				],
				[
					67.0652893,
					24.8739449
				],
				[
					67.0652855,
					24.8739446
				],
				[
					67.0652855,
					24.8739446
				],
				[
					67.0652954,
					24.8739397
				],
				[
					67.0652983,
					24.8739358
				],
				[
					67.0652983,
					24.8739358
				]
			]) })
		}, 5000);

		return () => clearInterval(interval);

	}, [selectedRider])

  	// useEffect(() => {
	// 	socket.on("receive_message", async(data) => {
	// 		let prevCoords = data.coordsList;
    //         prevCoords.unshift([67.06514346480135, 24.873956517462556])
    //         getMatch(prevCoords);
	// 	});
	// },[socket])

	useEffect(() => {
		
	  }, [selectedRider])

	async function getMatch(coordinates){
		let limit = 0;
		let parsedCoords = [];
		if(coordinates.length>100){
			limit = (coordinates.length/98);
			if(limit-parseInt(limit)>0.5){ limit = parseInt(limit)+2 } else { limit = parseInt(limit)+1 }
			
			coordinates.forEach((x, index) => {
				if(index%limit==0){
					console.log(true)
					parsedCoords.push(x)
				}
			});
			console.log(parsedCoords);
		}

		let newCoords = '';
		let radiuses = '';
		parsedCoords.forEach((x, index)=>{
			if(index<1){
				newCoords = x;
				radiuses = '25'
			}else if(index>0){
				newCoords = newCoords +';'+ x;
				radiuses = radiuses+';'+'25'
			}
		});
		const query = await fetch(`https://api.mapbox.com/matching/v5/mapbox/driving/${newCoords}?geometries=geojson&radiuses=${radiuses}&steps=true&access_token=${mapboxgl.accessToken}`,{method:'GET'});
		const response = await query.json();
		console.log(response)
		if(response.code === 'Ok'){
			let tempMapData = mapData;
			tempMapData.features[0].geometry.coordinates = response.matchings[0].geometry.coordinates;
			setMapData(tempMapData)
			map.getSource('trace').setData(mapData);
			map.panTo(response.matchings[0].geometry.coordinates[(response.matchings[0].geometry.coordinates.length)-1]);
			
			let tempMarkerData = markerData;
			tempMarkerData.features[0].geometry.coordinates = response.matchings[0].geometry.coordinates[0]
			tempMarkerData.features[1].geometry.coordinates = response.matchings[0].geometry.coordinates[(response.matchings[0].geometry.coordinates.length)-1]
			setMarkerData(tempMarkerData)

			map.getSource('points').setData(tempMarkerData);
		}
	}

  return (
    <>
      	<div ref={mapContainer} style={{width:'70vw', height:'62vh', border:'1px solid silver', borderRadius:5}}></div>
	</>
  )
}

export default LineTraceMap;